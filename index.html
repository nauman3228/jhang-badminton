<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City Badminton Club | Jhang Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .glass-card { background: white; border: 1px solid #e5e7eb; border-radius: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05); }
        .input-light { background-color: #f9fafb; border: 1.5px solid #e5e7eb; color: #111827; }
        .admin-only { display: none; }
        #lastMonthBalance:disabled { cursor: not-allowed; background-color: #f1f5f9; border-radius: 8px; padding-left: 8px; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="min-h-screen pb-20">

<div class="max-w-6xl mx-auto px-6 py-10">
    <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
        <div>
            <h1 class="text-3xl font-bold tracking-tight text-slate-900">üè∏City <span class="text-blue-600">Badminton Club</span></h1>
            <p class="text-slate-500 font-bold tracking-widest uppercase text-xs mt-1">Jhang City ‚Ä¢ Public Ledger</p>
        </div>
        <div class="flex gap-3 no-print">
            <button id="adminBtn" onclick="toggleAdmin()" class="bg-white border border-slate-300 text-slate-700 px-5 py-2 rounded-xl font-bold hover:bg-slate-50 shadow-sm transition-all flex items-center gap-2">
                <span id="lockIcon">üîí</span> <span id="adminText">Admin Login</span>
            </button>
            <button onclick="window.print()" class="bg-slate-900 text-white px-5 py-2 rounded-xl font-semibold hover:bg-slate-800 shadow-lg transition-all">üñ®Ô∏è Print</button>
        </div>
    </header>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
        <div class="glass-card p-6 border-b-4 border-blue-500">
            <p class="text-xs font-bold text-slate-500 uppercase mb-2">Opening Balance</p>
            <input id="lastMonthBalance" type="number" onchange="updateOpening(this.value)" class="bg-transparent text-2xl font-bold w-full outline-none text-slate-800" disabled placeholder="0">
        </div>
        <div class="glass-card p-6 border-b-4 border-emerald-500">
            <p class="text-xs font-bold text-slate-500 uppercase mb-2 text-emerald-600">Total All-Time Inc</p>
            <h2 id="totalIncome" class="text-2xl font-bold text-emerald-600">0</h2>
        </div>
        <div class="glass-card p-6 border-b-4 border-rose-500">
            <p class="text-xs font-bold text-slate-500 uppercase mb-2 text-rose-600">Total All-Time Exp</p>
            <h2 id="totalExpense" class="text-2xl font-bold text-rose-600">0</h2>
        </div>
        <div class="glass-card p-6 bg-slate-900 border-none shadow-xl">
            <p class="text-xs font-bold text-slate-400 uppercase mb-2 text-white">Net Cash Balance</p>
            <h2 id="netBalance" class="text-2xl font-bold text-white">0</h2>
        </div>
    </div>

    <div class="glass-card p-6 mb-10 bg-white border-l-8 border-blue-600">
        <h3 class="font-bold text-lg text-slate-800 mb-6">üìÖ History for: <input type="month" id="viewMonth" onchange="renderAll()" class="bg-blue-50 text-blue-700 px-2 py-1 rounded-lg"></h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100">
                <p class="text-[10px] font-bold text-emerald-600 uppercase">Monthly Collections</p>
                <p class="text-2xl font-bold text-emerald-700">Rs. <span id="monthlyIncome">0</span></p>
            </div>
            <div class="bg-rose-50 p-4 rounded-2xl border border-rose-100">
                <p class="text-[10px] font-bold text-rose-600 uppercase">Monthly Spending</p>
                <p class="text-2xl font-bold text-rose-700">Rs. <span id="monthlyExpense">0</span></p>
            </div>
        </div>
    </div>

    <section class="admin-only glass-card p-6 mb-10 bg-slate-50 border-dashed border-2 border-slate-300">
        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">‚öôÔ∏è Admin Settings</h3>
        <div class="flex flex-wrap gap-4 items-end">
            <div>
                <label class="text-[10px] font-bold text-slate-500 uppercase">Change Admin Password</label>
                <input id="newPass" type="password" placeholder="New Password" class="input-light block w-48 p-2 rounded-lg text-sm mt-1">
            </div>
            <button onclick="changePassword()" class="bg-slate-700 text-white px-4 py-2 rounded-lg text-sm font-bold">Update Password</button>
        </div>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-12">
        <div class="lg:col-span-4">
            <section class="glass-card p-6 h-full"><h3 class="font-bold text-lg mb-4">üë§ Members</h3><div class="admin-only flex gap-2 mb-4"><input id="newMemberName" type="text" placeholder="Add Member" class="input-light px-3 py-2 rounded-lg w-full"><button onclick="addMember()" class="bg-blue-600 text-white px-4 rounded-lg font-bold">+</button></div><div id="memberStatusList" class="space-y-2 max-h-80 overflow-y-auto"></div></section>
        </div>
        <div class="lg:col-span-4">
            <section class="glass-card p-6 border-t-4 border-emerald-500 h-full"><h3 class="font-bold text-lg mb-4 text-emerald-600">üí∞ Collection Log</h3><div class="admin-only space-y-2 mb-4"><input id="fundDate" type="date" class="input-light w-full p-2 rounded-lg text-sm"><select id="fundMemberSelect" class="input-light w-full p-2 rounded-lg text-sm"></select><input id="fundAmount" type="number" placeholder="Amount" class="input-light w-full p-2 rounded-lg text-sm"><button onclick="addFund()" class="w-full bg-emerald-600 text-white font-bold py-2 rounded-lg">Save Income</button></div><table class="w-full text-[11px]"><tbody id="fundHistory" class="divide-y"></tbody></table></section>
        </div>
        <div class="lg:col-span-4">
            <section class="glass-card p-6 border-t-4 border-rose-500 h-full"><h3 class="font-bold text-lg mb-4 text-rose-600">üí∏ Expense Log</h3><div class="admin-only space-y-2 mb-4"><input id="expDate" type="date" class="input-light w-full p-2 rounded-lg text-sm"><input id="expDetail" type="text" placeholder="Detail" class="input-light w-full p-2 rounded-lg text-sm"><input id="expAmount" type="number" placeholder="Amount" class="input-light w-full p-2 rounded-lg text-sm"><button onclick="addExpense()" class="w-full bg-rose-600 text-white font-bold py-2 rounded-lg">Save Expense</button></div><table class="w-full text-[11px]"><tbody id="expenseHistory" class="divide-y"></tbody></table></section>
        </div>
    </div>

    <section class="no-print glass-card p-8 bg-slate-100">
        <h3 class="font-bold text-xl mb-8 text-center text-slate-700">üìú Historical Records (All-Time)</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-white p-4 rounded-xl shadow-sm">
                <label class="text-[10px] font-bold text-blue-500 uppercase">Search Member History</label>
                <select id="historyMemberSelect" onchange="renderMemberHistory()" class="input-light w-full p-2 rounded-lg mt-1 mb-4"></select>
                <div id="memberHistoryResult" class="hidden text-sm"><table class="w-full"><tbody id="historyMemberTable" class="divide-y"></tbody></table></div>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm">
                <label class="text-[10px] font-bold text-rose-500 uppercase">Search Expense Type</label>
                <select id="historyExpenseSelect" onchange="renderExpenseHistory()" class="input-light w-full p-2 rounded-lg mt-1 mb-4"></select>
                <div id="expenseHistoryResult" class="hidden text-sm"><table class="w-full"><tbody id="historyExpenseTable" class="divide-y"></tbody></table></div>
            </div>
        </div>
    </section>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBRBq6D2ArZ-LlIyAfqU_Qjm8-SAmf0_q8", authDomain: "jhangbadminton.firebaseapp.com", projectId: "jhangbadminton", databaseURL: "https://jhangbadminton-default-rtdb.firebaseio.com", storageBucket: "jhangbadminton.firebasestorage.app", messagingSenderId: "845495083243", appId: "1:845495083243:web:523d6f8770d8129f491eae" };
    firebase.initializeApp(firebaseConfig);
    const dbRef = firebase.database().ref('clubData');
    
    // Default data structure including password
    let db = { openingBalance: 0, members: [], funds: [], expenses: [], adminPass: "1234" };
    let isAdmin = false;

    dbRef.on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) { 
            db = data; 
            if(!db.members) db.members=[]; 
            if(!db.funds) db.funds=[]; 
            if(!db.expenses) db.expenses=[];
            if(!db.adminPass) db.adminPass = "1234"; // Default fallback
        }
        renderAll();
    });

    function save() { dbRef.set(db); }

    function toggleAdmin() {
        if (!isAdmin) {
            const pass = prompt("Enter Admin Password:");
            if (pass === db.adminPass) {
                isAdmin = true;
                updateAdminUI(true);
            } else {
                alert("Incorrect password!");
            }
        } else {
            if (confirm("Logout?")) { isAdmin = false; updateAdminUI(false); }
        }
    }

    function changePassword() {
        const newP = document.getElementById('newPass').value;
        if(newP.length < 4) { alert("Password must be at least 4 characters"); return; }
        db.adminPass = newP;
        save();
        alert("Password updated successfully!");
        document.getElementById('newPass').value = "";
    }

    function updateAdminUI(loggedIn) {
        const btn = document.getElementById('adminBtn');
        const text = document.getElementById('adminText');
        const icon = document.getElementById('lockIcon');
        if (loggedIn) {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
            document.getElementById('lastMonthBalance').disabled = false;
            text.innerText = "Logout"; icon.innerText = "üîì";
            btn.className = "bg-rose-100 border border-rose-300 text-rose-700 px-5 py-2 rounded-xl font-bold shadow-sm transition-all hover:bg-rose-200";
        } else {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
            document.getElementById('lastMonthBalance').disabled = true;
            text.innerText = "Admin Login"; icon.innerText = "üîí";
            btn.className = "bg-white border border-slate-300 text-slate-700 px-5 py-2 rounded-xl font-bold hover:bg-slate-50 transition-all";
        }
        renderAll();
    }

    window.onload = () => { document.getElementById('viewMonth').value = new Date().toISOString().substring(0, 7); document.getElementById('fundDate').valueAsDate = new Date(); document.getElementById('expDate').valueAsDate = new Date(); };

    function addMember() { const v = document.getElementById('newMemberName').value.trim(); if(v){db.members.push(v); save(); document.getElementById('newMemberName').value="";}}
    function deleteMember(idx) { if(confirm("Delete?")){ db.members.splice(idx,1); save(); }}
    function editMember(idx) { const n = prompt("Edit:", db.members[idx]); if(n){db.members[idx]=n; save();}}
    function addFund() { const d = document.getElementById('fundDate').value, n = document.getElementById('fundMemberSelect').value, a = parseInt(document.getElementById('fundAmount').value); if(d && n && a){ db.funds.unshift({d, n, a, id: Date.now()}); save(); }}
    function editFund(id) { const i = db.funds.find(f => f.id === id), nD = prompt("Date:", i.d), nA = prompt("Amount:", i.a); if(nD && nA){ i.d = nD; i.a = parseInt(nA); save(); }}
    function deleteFund(id) { if(confirm("Delete?")){ db.funds = db.funds.filter(f=>f.id!==id); save(); }}
    function addExpense() { const d = document.getElementById('expDate').value, det = document.getElementById('expDetail').value, a = parseInt(document.getElementById('expAmount').value); if(d && det && a){ db.expenses.unshift({d, det, a, id: Date.now()}); save(); }}
    function editExpense(id) { const i = db.expenses.find(e => e.id === id), nD = prompt("Date:", i.d), nDet = prompt("Detail:", i.det), nA = prompt("Amount:", i.a); if(nD && nDet && nA){ i.d = nD; i.det = nDet; i.a = parseInt(nA); save(); }}
    function deleteExpense(id) { if(confirm("Delete?")){ db.expenses = db.expenses.filter(e=>e.id!==id); save(); }}
    function updateOpening(v) { db.openingBalance = parseInt(v) || 0; save(); }

    function renderAll() {
        const m = document.getElementById('viewMonth').value;
        const tin = db.funds.reduce((s,f)=>s+f.a,0), tout = db.expenses.reduce((s,e)=>s+e.a,0);
        document.getElementById('totalIncome').innerText = tin.toLocaleString();
        document.getElementById('totalExpense').innerText = tout.toLocaleString();
        document.getElementById('netBalance').innerText = `Rs. ${(db.openingBalance + tin - tout).toLocaleString()}`;
        document.getElementById('lastMonthBalance').value = db.openingBalance;
        document.getElementById('monthlyIncome').innerText = db.funds.filter(f=>f.d.startsWith(m)).reduce((s,f)=>s+f.a,0).toLocaleString();
        document.getElementById('monthlyExpense').innerText = db.expenses.filter(e=>e.d.startsWith(m)).reduce((s,e)=>s+e.a,0).toLocaleString();
        const mDiv = document.getElementById('memberStatusList'), fs = document.getElementById('fundMemberSelect'), hs = document.getElementById('historyMemberSelect');
        mDiv.innerHTML = ""; fs.innerHTML = '<option value="">Member...</option>'; hs.innerHTML = '<option value="">Select Member...</option>';
        db.members.sort().forEach((name, i) => {
            const paid = db.funds.some(f => f.n === name && f.d.startsWith(m));
            mDiv.innerHTML += `<div class="flex justify-between items-center p-2 bg-slate-50 rounded-lg text-sm"><span>${name} ${paid ? '‚úÖ':''}</span><div class="admin-only" style="display:${isAdmin?'block':'none'}"><button onclick="editMember(${i})" class="text-blue-500 text-xs mr-2">Edit</button><button onclick="deleteMember(${i})" class="text-rose-400 text-xs">Del</button></div></div>`;
            fs.innerHTML += `<option value="${name}">${name}</option>`; hs.innerHTML += `<option value="${name}">${name}</option>`;
        });
        document.getElementById('fundHistory').innerHTML = db.funds.filter(f=>f.d.startsWith(m)).map(f=>`<tr><td class="py-2">${f.d.slice(5)}</td><td>${f.n}</td><td class="text-emerald-600 font-bold">+${f.a}</td><td class="admin-only text-right" style="display:${isAdmin?'table-cell':'none'}"><button onclick="editFund(${f.id})" class="mr-1">‚úèÔ∏è</button><button onclick="deleteFund(${f.id})">üóëÔ∏è</button></td></tr>`).join('');
        document.getElementById('expenseHistory').innerHTML = db.expenses.filter(e=>e.d.startsWith(m)).map(e=>`<tr><td class="py-2">${e.d.slice(5)}</td><td>${e.det}</td><td class="text-rose-600 font-bold">-${e.a}</td><td class="admin-only text-right" style="display:${isAdmin?'table-cell':'none'}"><button onclick="editExpense(${e.id})" class="mr-1">‚úèÔ∏è</button><button onclick="deleteExpense(${e.id})">üóëÔ∏è</button></td></tr>`).join('');
        const es = document.getElementById('historyExpenseSelect'); es.innerHTML = '<option value="">Category...</option>';
        Array.from(new Set(db.expenses.map(e=>e.det))).forEach(d=>{es.innerHTML+=`<option value="${d}">${d}</option>`});
    }

    function renderMemberHistory() {
        const s = document.getElementById('historyMemberSelect').value; if(!s) return;
        const l = db.funds.filter(f=>f.n===s);
        document.getElementById('historyMemberTable').innerHTML = l.map(f=>`<tr><td>${f.d}</td><td class="text-right font-bold text-emerald-600">${f.a}</td></tr>`).join('');
        document.getElementById('memberHistoryResult').classList.remove('hidden');
    }
    function renderExpenseHistory() {
        const s = document.getElementById('historyExpenseSelect').value; if(!s) return;
        const l = db.expenses.filter(e=>e.det===s);
        document.getElementById('historyExpenseTable').innerHTML = l.map(e=>`<tr><td>${e.d}</td><td class="text-right font-bold text-rose-600">${e.a}</td></tr>`).join('');
        document.getElementById('expenseHistoryResult').classList.remove('hidden');
    }
</script>
</body>
</html>
